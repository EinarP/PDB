EPhealth
========================================================
Assumption: lifestyle affects health
```{r dbcon, echo=FALSE, cache=F}
enLocale <- Sys.setlocale("LC_TIME", "English")

goalCol <- "red"
trendCol <- "blue"

#TODO: data connections through a generic function
pdbDir <- '../../OneDrive/References/Data'

library(RSQLite, quietly=T)
pdbc <- dbConnect(SQLite(), dbname=paste(pdbDir, "p.db", sep="/"))
obs <- dbGetQuery(conn=pdbc, "select * from obs")

obsnum <- obs[obs$elem != "socact", ]
obschar <- obs[obs$elem == "socact", ]

library(reshape)
obslnum <- data.frame(date=as.Date(obsnum$dtstart), elem=obsnum$elem, elval=as.numeric(obsnum$elval))
obsw <- cast(obslnum, date ~ elem, value="elval")

obslchar <- data.frame(date=as.Date(obschar$dtstart), socact=as.character(obschar$elval))
obsw <- merge(obsw, obslchar, by.x = "date", by.y = "date", all = TRUE)

#vis <- cast(curdomout, timestamp ~ elem, value="elval")
#vis <- vis[c("timestamp","glasses","vision","visionMin")]
#vis$timestamp <- as.Date(vis$timestamp)
#vis
```
## Daily measurements

```{r fig.width=12, echo=F, fig.height=7}
tail(obsw[, c("date", "weight", "fat", "steps")], 8)

#Weight
plot(obsw$date, obsw$weight, type="l", main="Weight", ylim=c(64, 86))
segments(as.Date("2003-11-01"), 70, max(obsw$date), 70, col=goalCol)
segments(as.Date("2008-09-01"), 65, max(obsw$date), 65, col=goalCol)

#Fat
ofat <- obsw[!is.na(obsw$fat),c("date", "fat")]
ofatlm <- lm(ofat$fat~ofat$date)
plot(ofat$date, ofat$fat, main="Fat%", ylim=c(11, 21))
sapply(c(12, 16), function(k) abline(h=k, col=goalCol)) -> dumb
abline(ofatlm, col=trendCol)

#Steps
osteps <- obsw[!is.na(obsw$steps), c("date", "steps")]
ostepslm <- lm(osteps$steps~osteps$date)
plot(osteps$date, osteps$steps, type="h", main="Steps")
abline(h=10000, col=goalCol)
abline(ostepslm, col=trendCol)
```

TODO! add points to highlight drastic weight changes

TODO! add monthly average weight changes line

TODO! Eating?, Sleep

TODO! RHR

## Weekly summary
### Activity level

```{r tp, fig.width=12, fig.height=5, echo=F}
act <- obsw[!(is.na(obsw$steps) & is.na(obsw$trnaer) & is.na(obsw$trnana)), ]
act <- act[ ,c("date", "steps", "trnaer", "trnana", "socact")]
act$yearweek <- paste0(format(act$date, "%Y"), "-", strftime(as.POSIXlt(act$date), format="%W"))

stepsmean <- aggregate(steps ~ yearweek, data=act, mean)
stepsmean$steps <- ifelse(stepsmean$steps < 10000, 0, 1 + round((stepsmean$steps-10000)/5000))

trnana <- aggregate(trnana ~ yearweek, data=act, length)
trnaer <- aggregate(trnaer ~ yearweek, data=act, length)
socact <- aggregate(socact ~ yearweek, data=act, length)
actsum <- Reduce(function(x, y) merge(x, y, all=TRUE), list(stepsmean, trnana, trnaer, socact))

tail(actsum, 8)

actsum[is.na(actsum)] <- 0
barplot(t(as.matrix(actsum[,2:5])), names.arg=actsum[,1], col=c("darkgreen", "darkred", "darkblue", "yellow"), ylim=c(0, 10), legend.text=T, args.legend=list(ncol=4, x="topleft"))
box()
abline(h=3, lty=3)
abline(h=6, lty=3)
```
TODO! Last and first week of the year handling (using common week numbers?)

TODO! Aggregate past years' data

TODO! Activity level correlation with sleep

H0: No correlation; HA: Activity level affects sleep

## Yearly measurements

```{r heartpanel, echo=F}
par(mfrow = c(2, 2))

ochol <- obsw[!is.na(obsw$chol_hdl),c("date", "chol_hdl", "chol_ldl", "chol_tot")]
ochol$tothdlr <- ochol$chol_tot/ochol$chol_hdl

ocrp <- obsw[!is.na(obsw$crp),c("date", "crp")]
ohcy <- obsw[!is.na(obsw$hcy),c("date", "hcy")]
ovitd <- obsw[!is.na(obsw$vit_D),c("date", "vit_D")]

Reduce(function(x, y) merge(x, y, all=TRUE), list(ochol, ocrp, ohcy, ovitd))

plot(ochol$date, ochol$tothdlr, main=expression("Cholesterol Total/HDL ratio, <g"), ylim=c(1, 6))
abline(h=2.5, col=goalCol) #[TRANCEND]
ochollm <- lm(ochol$tothdlr~ochol$date)
abline(ochollm, col=trendCol)

plot(ocrp$date, ocrp$crp, main=expression("CRP, mg/l, <g"), ylim=c(0, 4))
abline(h=1.3, col=goalCol) #[TRANCEND]

plot(ohcy$date, ohcy$hcy, main=expression(paste("Homocysteine, ", mu, "mol/l, <g")), ylim=c(3, 16))
abline(h=7.5, col=goalCol) #[TRANCEND]

plot(ovitd$date, ovitd$vit_D, main=expression("Vitamin D, nmol/l, >g"), ylim=c(20, 100))
abline(h=80, col=goalCol) #[Quattromed]
```

TODO! Color coding for optimal and not optimal values

```{r vis, fig.width=7, fig.height=6, echo=F}
#pdbc
#with(vis, {
#    plot(vis$timestamp, as.numeric(vis$glasses), col='green', type='l', ylim=c(-6, 1))
#    cl <- vis[!is.na(vis$visionMin), c("timestamp", "visionMin")]
#    lines(cl[[1]], as.numeric(cl[[2]]), col='blue', type='l')
#    cl <- vis[!is.na(vis$vision), c("timestamp", "vision")]
#    lines(cl[[1]], as.numeric(cl[[2]]), col='red', type='l')    
#    legend("topleft", col=c('blue', 'red', 'green'), lty=c(1, 1, 1), bty='n',
#        legend=c("goal", "vision", "glasses"))
#})
```